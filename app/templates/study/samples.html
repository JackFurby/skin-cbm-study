{% extends "template_parts/base.html" %}


{% block content %}
<main class="col px-md-4">
	<div class="bg-white p-3 mt-4">

		<div class="row">

			<div id="ai-prediction" class="bg-white pt-3">
				<div class="container-fluid" style="max-width: 1140px;">
				<div class="row mb-3">
					<div class="col-3">
						<div class="row">
							<div class="col-12 m-sm-auto m-md-0">
								<img class="mb-3" src="{{ url_for('study.get_image', filename=sample_id|string + '/input.png') }}" width="100%" id="model_input" style="max-width: 369px;">
							</div>
						</div>
					</div>
					<div class="col-9">
						<div class="card border-info mb-3">
							<div class="card-header">
							AI prediction
							</div>
							<div class="card-body">
								<p class="card-text" id="task-out"></p>
							</div>
						</div>
					</div>
			</div>
			</div>
			</div>

			<button class="btn btn-primary col-4 mx-auto mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseConcepts" aria-expanded="false" aria-controls="collapseConcepts">
				View/hide concepts
			</button>
			<div class="collapse" id="collapseConcepts" style="transition: 0.8s;">
				<h4>Predicted concepts</h4>

				<label for="concept_order" class="form-label">Concept order</label>
				<select class="form-select mb-3" aria-label="concept_order" id="concept_order" onChange="orderConcepts(this.options[this.selectedIndex].value, true)">
					<option selected value="hl">Highest to lowest concept value</option>
					<option value="lh">Lowest to highest concept value</option>
				</select>
				<div class="row" id="all_explanations">
					{% for concept in concept_out %}
						{% set concept_id = concept[0] %}

						<div class="col-6" id="explanation_{{ concept_id }}">
							<div class="card mb-3">
								{% if explanation_version == 0 %}
									<div class="card-body">
										<p class="card-text">{{ concept[3] }}</p>
										<input type="hidden" id="{{ concept_id }}-initial" value="{{ concept[2]|round(2) }}">
										<input type="range" class="form-range" min="0" max="1" step="0.01" value="{{ concept[2]|round(2) }}" id="{{ concept_id }}" name="{{ concept_id }}" onchange="enableBtn('{{ concept_id }}-reset'); updateValue('{{ concept_id }}'); logUpdate('{{ concept_id }}', '{{ sample_id }}', false); predict();">
										<p><span class="badge rounded-pill bg-secondary" id="{{ concept_id }}-badge">{{ concept[2]|round(2) }}</span></p>
										<button type="button" class="btn btn-secondary" onclick="resetValue({{ concept_id }})" id="{{ concept_id }}-reset" disabled>Reset</button>
									</div>
								{% elif explanation_version == 1 %}
									<div class="row g-0">
										<div class="col-md-4">
											<img class="img-fluid rounded-start" src="{{ url_for('study.get_image', filename=sample_id|string + '/' + concept[1]|string) }}" width="100%">
										</div>
										<div class="col-md-8">
											<div class="card-body">
													<p class="card-text">{{ concept[3] }}</p>
													<input type="hidden" id="{{ concept_id }}-initial" value="{{ concept[2]|round(2) }}">
													<input type="range" class="form-range" min="0" max="1" step="0.01" value="{{ concept[2]|round(2) }}" id="{{ concept_id }}" name="{{ concept_id }}" onchange="enableBtn('{{ concept_id }}-reset'); updateValue('{{ concept_id }}'); logUpdate('{{ concept_id }}', '{{ sample_id }}', false); predict();">
													<p><span class="badge rounded-pill bg-secondary" id="{{ concept_id }}-badge">{{ concept[2]|round(2) }}</span></p>
													<button type="button" class="btn btn-secondary" onclick="resetValue({{ concept_id }})" id="{{ concept_id }}-reset" disabled>Reset</button>
											</div>
										</div>
									</div>
								{% endif %}
							</div>
						</div>

					{% endfor %}
				</div>
			</div>

			<P class="h4 text-center">Please label the sample</p>

			<form action="" method="post">
				{{ form.hidden_tag() }}
				{{ form.model_malignant (class_="d-none") }}
				<div class="d-flex justify-content-center">
					<button type="submit" name=submit class="btn btn-secondary col-3 mx-2", value="malignant">Malignant</button>
					<button type="submit" name=submit class="btn btn-secondary col-3 mx-2", value="benign">Benign</button>
				</div>
			</form>
		</div>

		<br/>

		<a class="btn btn-primary" href="{{ url_for('study.sample_survey') }}" role="button">Sample survey</a>
	</div>

</main>

<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/dist/ort.min.js"></script>

<script type="text/javascript">

	var last_recorded_action_time = Date.now();
	const sample_id = {{ sample_id }};

	// reset concept value to initial on button click
	function resetValue(input_id) {
		initial_value = document.getElementById(input_id + "-initial").value;
		document.getElementById(input_id).value = initial_value;
		document.getElementById(input_id + "-reset").disabled = true;
		document.getElementById(input_id + "-badge").innerHTML = initial_value;
		logUpdate(input_id, sample_id, true);
		predict();
	};

	// enabe reset button
	function enableBtn(btn_id) {
		document.getElementById(btn_id).disabled = false;
	};

	// update readout for slider value and update concept image
	function updateValue(input_id) {
		new_value = document.getElementById(input_id).value;
		document.getElementById(input_id + "-badge").innerHTML = new_value;
	};

	// log user changes to concept predictions
	function logUpdate(concept_id, sample_id, reset_pressed) {

		action_time = Date.now();

		$.ajax({
			type:'POST',
			url:'{{ url_for('study.log_range_update') }}',
			data:{
				type: "range",
				last_action_time: last_recorded_action_time,
				action_time: action_time,
				update_value: document.getElementById(concept_id).value,  // range html object id is the same as the concept id
				concept_id: concept_id,
				sample_id: sample_id,
				reset_pressed: reset_pressed,
			}
		});

		last_recorded_action_time = action_time;
	};

	const allExplanaions = document.querySelectorAll('[id^="explanation_"]');

	allExplanaions.forEach(explanation_object => {
		// log whenever concept explanations are visible
		var observer = new IntersectionObserver((entries) => {
			if (entries[0].intersectionRatio >= 0.001) {  // using ratio as without logs are less consistent
				var concept_id = entries[0]['target'].id.split("_")[1] // get concept id
				$.ajax({
					type:'POST',
					url:'{{ url_for('study.log_concept_seen') }}',
					data:{
						type: "concept visible",
						action_time: Date.now(),
						concept_id: concept_id,
						sample_id: sample_id,
					}
				});
			}
		});

		observer.observe(explanation_object);
	});

	// predict downstrea task from concept values
	async function predict() {
		// load model
		const session = await ort.InferenceSession.create("{{ url_for('study.static', filename=model_name) }}");

		// get concpet values and turn into tensor
		var concept_arr = [];
		{% for concept in concept_out %}
			concept_arr.push(document.getElementById("{{ concept[0] }}").value);
		{% endfor %}
		const concept_vec = new Float32Array(concept_arr);
		const tensorA = new ort.Tensor('float32', concept_vec, [1, 22]);

		// prepare feed for models. Key is the model input name
		const feeds = { "onnx::Gemm_0": tensorA };

		// get downstream task predictions
		const results = await session.run(feeds);

		// Get index of highest value in downsream task predictions
		const task_output = results["7"].data;
		var maxNum = Math.max.apply(null, task_output);
		var index = task_output.indexOf(maxNum);

		// update task out prediction displayed
		if (index <= 0) {
			document.getElementById("task-out").innerHTML = "benign";
		} else {
			document.getElementById("task-out").innerHTML = "malignant";
		};

		 // set inital model prediction if it has not been set already
		if (document.getElementById("model_malignant").value === "") {
			document.getElementById("model_malignant").value = document.getElementById("task-out").innerHTML;
		}
	};

	//https://bootstrap-menu.com/detail-fixed-onscroll.html
	document.addEventListener("DOMContentLoaded", function(){
		window.addEventListener('scroll', function() {
			if (window.scrollY > 50) {
				document.getElementById('ai-prediction').classList.add('fixed-top');
			} else {
				document.getElementById('ai-prediction').classList.remove('fixed-top');
			}
		});
	});

	// reorder concept explanations
	function orderConcepts(orderby, logUpdate) {
		var concept_list = [];
		// add all concepts ids and values to array
		allExplanaions.forEach(explanation_object => {
			concept_list.push([explanation_object.id, document.getElementById(explanation_object.id.split('_')[1]).value])
		});

		// reorder aray
		if (orderby == "lh") {
			concept_list.sort(function(a,b){return a[1].localeCompare(b[1]);});
		} else {  // hl
			concept_list.sort(function(a,b){return a[1].localeCompare(b[1]);}).reverse();
		}

		// add each explanation to the div all_explanations in order of concept_list
		container = document.getElementById("all_explanations")
		concept_list.forEach(explanation => {
			container.appendChild(document.getElementById(explanation[0]))
		});

		if (logUpdate) {
			action_time = Date.now();

			$.ajax({
				type:'POST',
				url:'{{ url_for('study.log_sort_update') }}',
				data:{
					type: "sort",
					action_time: action_time,
					update_value: orderby,
					sample_id: sample_id,
				}
			});
		};

		console.log("order");
	};

	// run all functions for the inital page load
	window.onload = function() {
		predict();
		orderConcepts("hl", false);
	};

</script>

{% endblock %}
